name: Test
on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: craftingstable
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - uses: actions/checkout@v4

      # ===== 1. EXTRA√á√ÉO DO JIRA ISSUE KEY & PROJECT KEY =====
      - name: Extract Jira Info
        id: extract_jira
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch name: $BRANCH_NAME"
          
          # Tenta extrair padroes como SCRUMDEMO-123, PROJ-456
          ISSUE_KEY=$(echo "$BRANCH_NAME" | grep -oP '[A-Z]+-\d+' | head -1 || echo "")
          
          # Se falhar, tenta padrao sem hifen (ex: SCRUMDEMO123)
          if [ -z "$ISSUE_KEY" ]; then
             ISSUE_KEY=$(echo "$BRANCH_NAME" | grep -oP '[A-Z]+\d+' | head -1 || echo "")
          fi
          
          # Extrai a Project Key (Tudo antes do numero ou hifen). Ex: SCRUMDEMO
          PROJECT_KEY=$(echo "$ISSUE_KEY" | sed -E 's/[-0-9]//g')

          echo "JIRA_ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          echo "JIRA_PROJECT_KEY=$PROJECT_KEY" >> $GITHUB_ENV
          
          if [ -n "$ISSUE_KEY" ]; then
            echo "‚úì Found Issue: $ISSUE_KEY (Project: $PROJECT_KEY)"
          else
            echo "‚ö† No Jira issue found. Will skip Xray upload."
          fi

      # ===== 2. SETUP DO AMBIENTE =====
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci || npm install

      # ===== 3. EXECU√á√ÉO DOS TESTES =====
      - name: Run frontend tests
        working-directory: frontend
        # Continua mesmo se falhar para podermos reportar os erros ao Xray
        continue-on-error: true
        run: npm run test --if-present

      - name: Run backend tests
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        # Continua mesmo se falhar para podermos reportar os erros ao Xray
        continue-on-error: true
        run: |
          if [ -n "$JWT_SECRET" ]; then
            mvn -B -f backend/pom.xml clean test -Djwt.secret="$JWT_SECRET"
          else
            mvn -B -f backend/pom.xml clean test
          fi

      # ===== 4. UPLOAD DE ARTIFACTS (BACKUP) =====
      - name: Upload backend test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/target/surefire-reports
          retention-days: 5

      # ===== 5. INTEGRA√á√ÉO COM XRAY (AUTOM√ÅTICA - ZIP) =====
      - name: Send Test Results to Xray
        if: always() && env.JIRA_ISSUE_KEY != '' && env.JIRA_PROJECT_KEY != ''
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
          XRAY_BASE_URL: https://xray.cloud.getxray.app/api/v2
        run: |
          set -e

          echo "üîê Authenticating with Xray..."
          TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
            -d "{\"client_id\":\"$XRAY_CLIENT_ID\",\"client_secret\":\"$XRAY_CLIENT_SECRET\"}" \
            "$XRAY_BASE_URL/authenticate" | tr -d '"')

          if [ -z "${TOKEN}" ] || [ "${TOKEN}" == "null" ]; then
            echo "‚ùå Failed to obtain Xray token. Check secrets." >&2
            exit 1
          fi

          echo "üì¶ Gathering XML test reports..."
          # Cria zip apenas com arquivos .xml existentes (trata nomes com espa√ßos)
          sudo apt-get install -y zip > /dev/null 2>&1 || true
          rm -f test_reports.zip

          find backend/target/surefire-reports frontend/test-results -type f -name '*.xml' -print0 2>/dev/null | \
            xargs -0 zip -j test_reports.zip || true

          if [ ! -f test_reports.zip ] || [ $(wc -c < test_reports.zip) -le 22 ]; then
            echo "‚ö† No XML reports found to upload."
            exit 0
          fi

          echo "‚úì Zip created: $(du -h test_reports.zip | cut -f1)"

          echo "üì§ Uploading to Xray (Auto-Provisioning)..."
          URL="${XRAY_BASE_URL}/import/execution/junit?projectKey=${JIRA_PROJECT_KEY}"
          echo "Target URL: .../import/execution/junit?projectKey=${JIRA_PROJECT_KEY}"

          # Enviar como multipart/form-data (campo 'file')
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${TOKEN}" \
            -F "file=@test_reports.zip;type=application/zip" \
            "$URL")

          echo "HTTP Status: $HTTP_CODE"
          cat response.json
          echo ""

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            NEW_EXEC_KEY=$(jq -r '.key' response.json 2>/dev/null || echo "Unknown")
            echo "‚úÖ SUCCESS! Test Execution created: $NEW_EXEC_KEY"
            echo "XRAY_EXEC_KEY=$NEW_EXEC_KEY" >> $GITHUB_ENV
          else
            echo "‚ùå Upload Failed."
            exit 1
          fi
          
          echo "‚úì Zip created: test_reports.zip ($(du -h test_reports.zip | cut -f1))"

          echo "======================================"
          echo "üì§ Uploading to Xray (Auto-Provisioning)..."
          echo "======================================"
          
          # Endpoint JUnit Standard.
          # projectKey: Obriga o Xray a criar a execu√ß√£o neste projeto.
          # Se os testes n√£o existirem, o Xray cria-os.
          
          URL="${XRAY_BASE_URL}/import/execution/junit?projectKey=${JIRA_PROJECT_KEY}"
          
          echo "Target URL: .../import/execution/junit?projectKey=${JIRA_PROJECT_KEY}"
          
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/zip" \
            --data-binary "@test_reports.zip" \
            "$URL")
          
          echo "HTTP Status: $HTTP_CODE"
          cat response.json
          echo ""

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
             NEW_EXEC_KEY=$(jq -r '.key' response.json 2>/dev/null || echo "Unknown")
             echo "‚úÖ SUCCESS! Test Execution created: $NEW_EXEC_KEY"
             echo "XRAY_EXEC_KEY=$NEW_EXEC_KEY" >> $GITHUB_ENV
          else
             echo "‚ùå Upload Failed."
             exit 1
          fi

      # ===== 6. COMENT√ÅRIO NO JIRA =====
      - name: Comment on Jira
        if: always() && env.XRAY_EXEC_KEY != ''
        continue-on-error: true
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ env.JIRA_ISSUE_KEY }}
          comment: |
            ü§ñ **CI Test Results**
            
            Build: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            üìÇ **Xray Execution:** [${{ env.XRAY_EXEC_KEY }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ env.XRAY_EXEC_KEY }})
            
            Status: ${{ job.status == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}