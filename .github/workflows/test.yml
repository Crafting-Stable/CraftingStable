  name: Test
  on:
    push:
      branches:
        - '**'
    pull_request:
      types: [opened, synchronize, reopened]
  jobs:
    test:
      name: Run Tests
      runs-on: ubuntu-latest
      services:
        postgres:
          image: postgres:15
          env:
            POSTGRES_DB: craftingstable
            POSTGRES_USER: postgres
            POSTGRES_PASSWORD: postgres
          ports:
            - 5432:5432
          options: >-
            --health-cmd="pg_isready -U postgres"
            --health-interval=10s
            --health-timeout=5s
            --health-retries=5
      steps:
        - uses: actions/checkout@v4

        - name: Extract Jira Issue Key
          id: extract_jira
          run: |
            BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
            # Try multiple patterns: SCRUM-XX, SCRUMDEMO-XX, or any [A-Z]+-XX format
            ISSUE_KEY=$(echo "$BRANCH_NAME" | grep -oP '(SCRUMDEMO|SCRUM|[A-Z]+)-\d+' | head -1 || echo "")
            echo "JIRA_ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
            if [ -n "$ISSUE_KEY" ]; then
              echo "Found Jira issue: $ISSUE_KEY"
            else
              echo "No Jira issue key found in branch name"
            fi

        - name: Login to Jira
          if: env.JIRA_ISSUE_KEY != ''
          continue-on-error: true
          uses: atlassian/gajira-login@v3
          env:
            JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
            JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
            JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

        - name: Set up JDK 21
          uses: actions/setup-java@v4
          with:
            java-version: 21
            distribution: 'zulu'
        - name: Cache Maven packages
          uses: actions/cache@v4
          with:
            path: ~/.m2
            key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
            restore-keys: ${{ runner.os }}-m2

        - name: Set up Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20.19.0'

        - name: Cache frontend node_modules
          uses: actions/cache@v4
          with:
            path: frontend/node_modules
            key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
            restore-keys: ${{ runner.os }}-node-

        - name: Install frontend dependencies
          working-directory: frontend
          run: npm install

        - name: Run frontend unit tests (Vitest)
          working-directory: frontend
          # NOTA: O comando 'test' DEVE ser configurado para gerar um relatório JUnit XML
          run: npm run test --if-present

        - name: Create .env file for Docker Compose
          run: |
            cat > .env << EOF
            POSTGRES_DB=craftingstable
            POSTGRES_USER=postgres
            POSTGRES_PASSWORD=postgres
            PAYPAL_CLIENT_ID=test
            PAYPAL_CLIENT_SECRET=test
            VITE_PAYPAL_CLIENT_ID=test
            EOF

        - name: Start Docker Compose services
          run: |
            docker compose up -d --build
            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 30
            # Check if frontend is responding
            for i in {1..30}; do
              if curl -s http://localhost:80 > /dev/null 2>&1; then
                echo "Frontend is ready!"
                break
              fi
              echo "Waiting for frontend... attempt $i"
              sleep 5
            done

        - name: Run frontend E2E tests (Cypress)
          working-directory: frontend
          # NOTA: O Cypress DEVE ser configurado com o reporter JUnit XML
          run: npx cypress run --headless --browser chrome
          continue-on-error: true

        - name: Stop Docker Compose
          if: always()
          run: docker compose down -v

        - name: Run backend tests
          env:
            JWT_SECRET: ${{ secrets.JWT_SECRET }}
          run: |
            if [ -n "$JWT_SECRET" ]; then
              echo "Using JWT_SECRET from GitHub Secrets (length: ${#JWT_SECRET})"
              mvn -B -f backend/pom.xml clean -Djwt.secret="$JWT_SECRET" -e test
            else
              echo "JWT_SECRET not set, using jwt.secret from application-test.properties"
              mvn -B -f backend/pom.xml clean -e test
            fi

        - name: Print test failure details on error
          if: failure()
          run: |
            echo "=== Test failures detected ==="
            find backend/target/surefire-reports -name "*.txt" -exec echo "File: {}" \; -exec cat {} \; 2>/dev/null || true

        - name: Upload backend test results
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: backend-test-results
            path: backend/target/surefire-reports
            retention-days: 5

        - name: Upload frontend test results
          if: always()
          uses: actions/upload-artifact@v4
          with:
            name: frontend-test-results
            path: frontend/test-results
            retention-days: 5

        - name: Upload Cypress screenshots on failure
          if: failure()
          uses: actions/upload-artifact@v4
          with:
            name: cypress-screenshots
            path: frontend/cypress/screenshots
            retention-days: 5

        - name: Send Test Results to Xray (manual upload)
          if: always() && env.JIRA_ISSUE_KEY != ''
          env:
            XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
            XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
            XRAY_BASE_URL: https://xray.cloud.getxray.app/api/v2
            ISSUE_KEY: ${{ env.JIRA_ISSUE_KEY }}
          run: |
            set -euo pipefail
            echo "Autenticando no Xray..."
            TOKEN=$(curl -s -H "Content-Type: application/json" -X POST -d "{\"client_id\":\"$XRAY_CLIENT_ID\",\"client_secret\":\"$XRAY_CLIENT_SECRET\"}" "$XRAY_BASE_URL/authenticate" | tr -d '"')
            if [ -z "${TOKEN}" ]; then
              echo "Falha ao obter token Xray" >&2
              exit 1
            fi
            echo "Token obtido (tamanho: ${#TOKEN})"
            
            upload_file() {
              local file="$1"
              echo "Enviando ${file} para Xray (Test Execution: ${ISSUE_KEY})..."
              http_response=$(curl -s -w "%{http_code}" -o /tmp/xray_resp -X POST \
                -H "Authorization: Bearer ${TOKEN}" \
                -F "file=@${file}" \
                "${XRAY_BASE_URL}/import/execution/junit?testExecKey=${ISSUE_KEY}")
              status=$http_response
              if [ "${status}" -ge 200 ] && [ "${status}" -lt 300 ]; then
                echo "Upload bem sucedido: ${file}"
                cat /tmp/xray_resp
              else
                echo "Erro no upload (${status}) para ${file}" >&2
                cat /tmp/xray_resp >&2
              fi
            }
            
            # Coletar relatórios JUnit XML
            declare -a reports
            while IFS= read -r -d '' f; do reports+=("$f"); done < <(find backend/target/surefire-reports -name "*.xml" -print0 2>/dev/null || true)
            while IFS= read -r -d '' f; do reports+=("$f"); done < <(find frontend/test-results -name "*.xml" -print0 2>/dev/null || true)
            while IFS= read -r -d '' f; do reports+=("$f"); done < <(find frontend/cypress/results -name "*.xml" -print0 2>/dev/null || true)
            
            if [ "${#reports[@]}" -eq 0 ]; then
              echo "Nenhum arquivo de relatório JUnit encontrado — pulando upload para Xray."
              exit 0
            fi
            
            for r in "${reports[@]}"; do
              if [ -f "$r" ]; then
                upload_file "$r"
              else
                echo "Arquivo não encontrado: $r"
              fi
            done

        - name: Comment on Jira on Success
          if: success() && env.JIRA_ISSUE_KEY != ''
          continue-on-error: true
          uses: atlassian/gajira-comment@v3
          with:
            issue: ${{ env.JIRA_ISSUE_KEY }}
            comment: |
              ✅ CI Tests Passed! Resultados importados para o Xray.
              Verifique a secção Test Coverage para a nova Test Execution ligada.
              Build: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

        - name: Comment on Jira on Failure
          if: failure() && env.JIRA_ISSUE_KEY != ''
          continue-on-error: true
          uses: atlassian/gajira-comment@v3
          with:
            issue: ${{ env.JIRA_ISSUE_KEY }}
            comment: |
              ❌ CI Tests Failed! Resultados (parciais) importados para o Xray.
              Build: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
              Por favor, verifique os [logs do workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) e a Test Execution.
