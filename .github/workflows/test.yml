name: Test
on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: craftingstable
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4

      # ===== EXTRA√á√ÉO DO JIRA ISSUE KEY =====
      - name: Extract Jira Issue Key
        id: extract_jira
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"
          echo "Branch name: $BRANCH_NAME"
          
          # Procura padr√µes como SCRUMDEMO193, SCRUM-123, etc.
          # Aceita tanto SCRUMDEMO193 quanto SCRUMDEMO-193
          ISSUE_KEY=$(echo "$BRANCH_NAME" | grep -oP 'SCRUMDEMO\d+|SCRUM-?\d+|[A-Z]+-\d+' | head -1 || echo "")
          
          echo "JIRA_ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          
          if [ -n "$ISSUE_KEY" ]; then
            echo "‚úì Found Jira issue: $ISSUE_KEY"
          else
            echo "‚ö† No Jira issue key found in branch name: $BRANCH_NAME"
            echo "Expected patterns: SCRUMDEMO193, SCRUM-123, PROJECT-456"
          fi

      # ===== LOGIN NO JIRA =====
      - name: Login to Jira
        if: env.JIRA_ISSUE_KEY != ''
        continue-on-error: true
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

      # ===== SETUP DO AMBIENTE =====
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'

      - name: Cache frontend node_modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: ${{ runner.os }}-node-

      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci
          else
            npm install
          fi

      # ===== EXECU√á√ÉO DOS TESTES =====
      - name: Run frontend tests
        working-directory: frontend
        run: npm run test --if-present

      - name: Run backend tests
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
        run: |
          if [ -n "$JWT_SECRET" ]; then
            echo "Using JWT_SECRET from GitHub Secrets"
            mvn -B -f backend/pom.xml clean test -Djwt.secret="$JWT_SECRET"
          else
            echo "Using jwt.secret from application-test.properties"
            mvn -B -f backend/pom.xml clean test
          fi
          
          # Verificar se os relat√≥rios foram gerados corretamente
          echo "Checking test reports..."
          if [ -d "backend/target/surefire-reports" ]; then
            ls -lh backend/target/surefire-reports/*.xml || echo "No XML files found"
            # Mostrar tamanho dos arquivos
            find backend/target/surefire-reports -name "*.xml" -exec sh -c 'echo "Size of {}: $(wc -c < {})" bytes' \;
          fi

      # ===== UPLOAD DE ARTIFACTS =====
      - name: Upload backend test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: backend/target/surefire-reports
          retention-days: 5

      - name: Upload frontend test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: frontend/test-results
          retention-days: 5

      # ===== INTEGRA√á√ÉO COM XRAY =====
      - name: Send Test Results to Xray
        if: always() && env.JIRA_ISSUE_KEY != ''
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
          XRAY_BASE_URL: https://xray.cloud.getxray.app/api/v2
          ISSUE_KEY: ${{ env.JIRA_ISSUE_KEY }}
        run: |
          set -euo pipefail
          
          echo "======================================"
          echo "üîê Authenticating with Xray..."
          echo "======================================"
          
          TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
            -d "{\"client_id\":\"$XRAY_CLIENT_ID\",\"client_secret\":\"$XRAY_CLIENT_SECRET\"}" \
            "$XRAY_BASE_URL/authenticate" | tr -d '"')
          
          if [ -z "${TOKEN}" ]; then
            echo "‚ùå Failed to obtain Xray token" >&2
            exit 1
          fi
          
          echo "‚úì Token obtained successfully (length: ${#TOKEN})"
          
          # Fun√ß√£o para fazer upload de um arquivo
          upload_file() {
            local file="$1"
            echo ""
            echo "üì§ Uploading: ${file}"
            echo "   Test Execution: ${ISSUE_KEY}"
          
            http_response=$(curl -s -w "%{http_code}" -o /tmp/xray_resp -X POST \
              -H "Authorization: Bearer ${TOKEN}" \
              -F "file=@${file}" \
              "${XRAY_BASE_URL}/import/execution/junit?testExecKey=${ISSUE_KEY}")
          
            status=$http_response
          
            if [ "${status}" -ge 200 ] && [ "${status}" -lt 300 ]; then
              echo "   ‚úì Upload successful (HTTP ${status})"
              cat /tmp/xray_resp
            else
              echo "   ‚ùå Upload failed (HTTP ${status})" >&2
              cat /tmp/xray_resp >&2
            fi
          }
          
          echo ""
          echo "======================================"
          echo "üîç Collecting JUnit XML reports..."
          echo "======================================"
          
          # Coletar todos os relat√≥rios JUnit XML
          declare -a reports
          
          # Backend reports (apenas arquivos n√£o vazios)
          while IFS= read -r -d '' f; do 
            if [ -s "$f" ]; then  # -s verifica se o arquivo n√£o est√° vazio
              reports+=("$f")
              size=$(wc -c < "$f")
              echo "   Found: $f ($size bytes)"
            else
              echo "   ‚ö† Skipping empty file: $f"
            fi
          done < <(find backend/target/surefire-reports -name "*.xml" -print0 2>/dev/null || true)
          
          # Frontend unit test reports
          while IFS= read -r -d '' f; do 
            if [ -s "$f" ]; then
              reports+=("$f")
              size=$(wc -c < "$f")
              echo "   Found: $f ($size bytes)"
            else
              echo "   ‚ö† Skipping empty file: $f"
            fi
          done < <(find frontend/test-results -name "*.xml" -print0 2>/dev/null || true)
          
          # Cypress E2E reports (se existirem)
          while IFS= read -r -d '' f; do 
            if [ -s "$f" ]; then
              reports+=("$f")
              size=$(wc -c < "$f")
              echo "   Found: $f ($size bytes)"
            else
              echo "   ‚ö† Skipping empty file: $f"
            fi
          done < <(find frontend/cypress/results -name "*.xml" -print0 2>/dev/null || true)
          
          if [ "${#reports[@]}" -eq 0 ]; then
            echo ""
            echo "‚ö† No JUnit XML reports found - skipping Xray upload"
            exit 0
          fi
          
          echo ""
          echo "Total reports found: ${#reports[@]}"
          
          echo ""
          echo "======================================"
          echo "üì§ Uploading reports to Xray..."
          echo "======================================"
          
          # Upload de cada relat√≥rio
          for r in "${reports[@]}"; do
            if [ -f "$r" ]; then
              upload_file "$r"
            else
              echo "   ‚ö† File not found: $r"
            fi
          done
          
          echo ""
          echo "======================================"
          echo "‚úì Xray upload process completed"
          echo "======================================"

      # ===== COMENT√ÅRIOS NO JIRA =====
      - name: Comment on Jira (Success)
        if: success() && env.JIRA_ISSUE_KEY != ''
        continue-on-error: true
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ env.JIRA_ISSUE_KEY }}
          comment: |
            ‚úÖ **CI Tests Passed!**
            
            Test results have been imported to Xray.
            Check the Test Coverage section for the new Test Execution.
            
            Build: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Comment on Jira (Failure)
        if: failure() && env.JIRA_ISSUE_KEY != ''
        continue-on-error: true
        uses: atlassian/gajira-comment@v3
        with:
          issue: ${{ env.JIRA_ISSUE_KEY }}
          comment: |
            ‚ùå **CI Tests Failed!**
            
            Partial test results have been imported to Xray.
            
            Build: [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            Please check the [workflow logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) and Test Execution for details.